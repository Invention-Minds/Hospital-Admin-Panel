<div class="form-row">

    <div class="column-1">
        <div class="p-field p-col-2">
            <p-dropdown [options]="searchOptions" [(ngModel)]="selectedSearchOption" placeholder="Search By"
                (ngModelChange)="onSearch()" class="custom-dropdown"></p-dropdown>
        </div>

        <div class="p-field p-col-3">
            <input pInputText [(ngModel)]="searchValue" placeholder="Search / 123456" class="custom-input-text" style="border-radius: 10px;"
                (ngModelChange)="onSearch()" />
        </div>

        <div class="p-field p-col-2 buttons-container">

            <svg (click)="onClear()" class="delete" xmlns="http://www.w3.org/2000/svg" width="3.5em" height="3.5em"
                viewBox="0 0 24 24">
                <path fill="#fff"
                    d="M7 21q-.825 0-1.412-.587T5 19V6q-.425 0-.712-.288T4 5t.288-.712T5 4h4q0-.425.288-.712T10 3h4q.425 0 .713.288T15 4h4q.425 0 .713.288T20 5t-.288.713T19 6v13q0 .825-.587 1.413T17 21zM17 6H7v13h10zm-7 11q.425 0 .713-.288T11 16V9q0-.425-.288-.712T10 8t-.712.288T9 9v7q0 .425.288.713T10 17m4 0q.425 0 .713-.288T15 16V9q0-.425-.288-.712T14 8t-.712.288T13 9v7q0 .425.288.713T14 17M7 6v13z" />
            </svg>

        </div>
    </div>

    <div class="p-field p-col-3">

    </div>

    <div class="p-field p-col-3 calendar">

        <button class="emg" (click)="openPopup()">
            <svg xmlns="http://www.w3.org/2000/svg" width="15" height="16" viewBox="0 0 15 16" fill="none">
                <g clip-path="url(#clip0_15372_1889)">
                    <path d="M5.37598 0.5V5.87598H0V10.124H5.37598V15.5H9.62403V10.124H15V5.87598H9.62403V0.5H5.37598Z"
                        fill="#FF4747" />
                </g>
                <defs>
                    <clipPath id="clip0_15372_1889">
                        <rect width="15" height="15" fill="white" transform="translate(0 0.5)" />
                    </clipPath>
                </defs>
            </svg> Emg. OT Form
        </button>

    </div>
</div>


<div class="table-container" [ngClass]="{'loading': isLoading}" *ngIf="!isLoading">
    <div class="table-wrapper">
        <table class="appointment-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th (click)="sortBy('firstName')" style="cursor: pointer;">
                        Patient Name
                        <span *ngIf="sortColumn === 'firstName' && sortDirection === 'asc'">&#9650;</span>
                        <span *ngIf="sortColumn === 'firstName' && sortDirection === 'desc'">&#9660;</span>
                    </th>
                    <th>Estimation ID</th>
                    <th>Surgery Name</th>
                    <th>Primary Surgeon</th>
                    <th>Room No</th>

                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngIf="filteredServices.length === 0">
                    <td colspan="11" class="no-records-message">
                        No records to display
                    </td>
                </tr>
                <tr *ngFor="let estimation of getPaginatedAppointments(); let i = index">
                    <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
                    <td>{{ estimation.patientName }}</td>
                    <td>{{ estimation.estimationId || '-'}}</td>
                    <td>
                        <span [pTooltip]="estimation.estimationName || estimation.surgeryName" tooltipPosition="top">
                            {{ (estimation.estimationName || estimation.surgeryName) | slice:0:10 }}
                            {{ (estimation.estimationName || estimation.surgeryName)?.length > 10 ? '...' : '' }}
                        </span>
                    </td>
                    <td>{{ estimation.OTDetails?.[0]?.handledBy || estimation.handledBy || '-' }}</td>
                    <td>{{ estimation.OTDetails?.[0]?.roomNo || estimation.roomNo || '-' }}</td>
                    <td class="button">

                        <button class="start"
                            [disabled]=" (estimation.OTDetails?.[0]?.isStarted || estimation.isStarted)"
                            (click)="!(estimation.OTDetails?.[0]?.isStarted || estimation.isStarted) && completeAppointment(estimation)">
                            <img class="image" src="/start.svg">Start
                        </button>
                        <button class="finish" [disabled]=" (estimation.OTDetails?.[0]?.isEnded || estimation.isEnded)"
                            (click)="!(estimation.OTDetails?.[0]?.isEnded || estimation.isEnded) && reportDoneAppointment(estimation)">
                            <img class="image" src="/finish.svg">Finish
                        </button>
                        <button class="details" (click)="showUpdateDetailsPopup(estimation)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="17" height="16" viewBox="0 0 17 16"
                                fill="none">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M14.5 4V14H4.5V4H14.5ZM13.1667 5.33334H5.83334V12.6667H13.1667V5.33334ZM12.5 2V3.33334L3.83331 3.33331V12H2.5V2H12.5ZM11.8333 9.33334V10.6667H7.16666V9.33334H11.8333ZM11.8333 6.66666V8H7.16666V6.66666H11.8333Z"
                                    fill="#FB9C2A" />
                            </svg> OT Details
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <div class="pagination">
        <button class="pagination-btn prev" (click)="prevPage()" [disabled]="currentPage === 1">←</button>
        <button class="pagination-btn next" (click)="nextPage()" [disabled]="currentPage === totalPages">→</button>
        <div class="page-info">
            Page
            <input type="number" [(ngModel)]="currentPage" min="1" [max]="totalPages" class="page-input"
                (change)="onPageChange()">
            of {{ totalPages }}
        </div>
    </div>
    <p-toast></p-toast>


</div>
<div class="loader" *ngIf="isLoading"></div>
<div *ngIf="showPopup" class="estimation-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>New OT Form</h3>
            <button class="popup-close" (click)="showPopup = false">
                <img src="/popup-close.svg" />
            </button>
        </div>
        <hr />
        <div class="modal-body">
            <div class="estimation-input-container">
                <input type="text" id="patientUHID" name="patientUHID" pattern="[A-Za-z0-9\-]+" class="custom-input"
                [(ngModel)]="prn" placeholder=" " (input)="onUHIDChange()" (focus)="uhidSuggestions = true"
                required />
              <label for="patientUHID" class="custom-label">PRN*</label>
    
              <!-- Suggestions Dropdown -->
              <ul class="prn-suggestions" *ngIf="uhidSuggestions && filteredUHIDPatients.length > 0">
                <li *ngFor="let patient of filteredUHIDPatients" (click)="selectUHID(patient)">
                  {{ patient.prn }} - {{ patient.name }}
                </li>
              </ul>
            </div>
            <div class="estimation-input-container">
                <!-- Input field for estimation -->
                <input type="text" [(ngModel)]="patientName" class="custom-input" />
                <label for="estimationText" class="custom-label">Patient Name*</label>
            </div>
            <div class="input-container">
                <input type="date" id="estimationDate" name="estimationDate" class="custom-input"
                    [(ngModel)]="surgeryDate" required />
                <label for="estimationDate" class="custom-label">Surgery Date*</label>
            </div>

            <div class="estimation-type">
                <label class="estimation-type-label">Estimation Type:</label>
                <div class="radio-buttons">
                    <label>
                        <input type="radio" name="estimationType" [(ngModel)]="estimationType" value="SM" />
                        Surgical Management
                    </label>
                    <label>
                        <input type="radio" name="estimationType" [(ngModel)]="estimationType" value="Maternity" />
                        Maternity Management
                    </label>
                </div>
            </div>


            <div class="estimation-type-container">
                <label class="estimation-type-label">Surgery Procedure:</label>
                <div class="radio-buttons">
                    <label>
                        <input type="radio" name="surgeryPackage" [(ngModel)]="surgeryType" value="single surgery"
                            (ngModelChange)="handleSurgeryNamesChange()" />
                        Single Surgery
                    </label>
                    <label>
                        <input type="radio" name="surgeryPackage" [(ngModel)]="surgeryType"
                            (ngModelChange)="handleSurgeryNamesChange()" value="multiple surgeries" />
                        Multiple Surgeries
                    </label>
                </div>
            </div>


            <div class="estimation-input-container">
                <!-- Input field for estimation -->
                <input type="text" [(ngModel)]="surgeryName" class="custom-input"
                    (ngModelChange)="handleSurgeryNamesChange()" />
                <label for="estimationText" class="custom-label">Procedure Name*</label>
                <div *ngIf="surgeryType === 'multiple surgeries'" class="estimation-note">
                    Note: Estimated Procedures:* (Eg: Surgery 1, Surgery 2, Surgery 3)
                </div>
            </div>

            <div class="input-container" *ngIf="surgeryType !== 'multiple surgeries'">
                <div class="single-container">
                    <label class="doctor-label">Surgeon Name*</label>
                    <p-dropdown class="doctor-dropdown p-float-label" [(ngModel)]="selectedDoctorId"
                        [options]="filteredDoctors" optionLabel="name" optionValue="id" [filter]="true" filterBy="name"
                        (ngModelChange)="updateSelectedDoctorName($event)" required placeholder="">
                    </p-dropdown>

                </div>
            </div>

            <!-- Multiple Surgeries Section -->
            <div class="multiple-surgery-doctor" *ngIf="surgeryType === 'multiple surgeries'">
                <div *ngFor="let surgery of surgeries; let i = index" class="multi-container">

                    <div class="dropdown-container p-float-label">
                        <p-dropdown class="doctor-dropdown" [options]="filteredDoctors" optionLabel="name"
                            optionValue="id" [(ngModel)]="selectedDoctors[i]" (onChange)="updateMultipleDoctor(i)"
                            [filter]="true" filterBy="name" required>
                        </p-dropdown>
                        <label class="doctor-label">
                            Surgeon Name for {{ surgery }}*
                        </label>
                    </div>

                    <!-- Radio button to select primary surgeon -->
                    <div class="primary-radio">
                        <input type="radio" name="primaryDoctor" class="primary-doctor" [value]="selectedDoctors[i]"
                            [(ngModel)]="primarySurgeonId" (ngModelChange)="setPrimarySurgeonName()">
                        <label>Mark as Primary</label>
                    </div>
                </div>
            </div>


            <div class="input-container">
                <select id="roomNo" name="roomNo" class="custom-input" [(ngModel)]="roomNo" required
                    #surgeryTimeModel="ngModel">
                    <option value="" disabled selected>Select Room</option>
                    <option value="OT 1">OT 1</option>
                    <option value="OT 2">OT 2</option>
                    <option value="OT 3">OT 3</option>
                    <option value="OT 4">OT 4</option>
                    <option value="OT 5">OT 5</option>
                    <option value="Minor 1">Minor 1</option>
                    <option value="Minor 2">Minor 2</option>
                </select>
                <label for="surgeryTime" class="custom-label">OT Room*</label>
            </div>

            <div class="input-container" *ngIf="estimationType === 'SM'">
                <select id="surgeryTime" name="surgeryTime" class="custom-input" [(ngModel)]="surgeryLevel" required
                    #surgeryTimeModel="ngModel">
                    <option value="" disabled selected>Select Surgery Level</option>
                    <option value="Level 1">Level 1</option>
                    <option value="Level 1A">Level 1A</option>
                    <option value="Level 2">Level 2</option>
                    <option value="Level 2A">Level 2A</option>
                    <option value="Level 3">Level 3</option>
                    <option value="Level 3A">Level 3A</option>
                    <option value="Level 4">Level 4</option>
                    <option value="Level 4A">Level 4A</option>
                    <option value="Level 5">Level 5</option>
                    <option value="Level 5A">Level 5A</option>
                    <option value="Level 6">Level 6</option>
                    <option value="Level 6A">Level 6A</option>
                    <option value="Level 7">Level 7</option>
                    <option value="Level 7A">Level 7A</option>
                    <option value="Level 8">Level 8</option>
                    <option value="Level 8A">Level 8A</option>
                </select>
                <label for="surgeryTime" class="custom-label">Surgery Level*</label>
            </div>

            <div class="estimation-type-container">
                <label class="estimation-amount-label">Amount Paid:</label>
                <div class="radio-buttons">
                    <label>
                        <input type="radio" name="amountPaid" [(ngModel)]="amountPaid" [value]='true' />
                        Yes
                    </label>
                    <label>
                        <input type="radio" name="amountPaid" [(ngModel)]="amountPaid" [value]='false' />
                        No
                    </label>
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <!-- <button class="save-button" (click)="saveEstimation()">Save</button> -->
            <button mat-raised-button (click)="!isButtonClicked && saveEstimation()" class="save-button"
                [disabled]="isButtonClicked" [class.spinner]="isButtonLoading"> <span>Save</span></button>
            <button class="close-button" (click)="showPopup=false">Close</button>
        </div>
    </div>
</div>

<div class="estimation-modal" *ngIf="showUpdateDetails">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Update OT Details of {{patientName}}</h3>
            <button class="popup-close" (click)="closePopup()">
                <img src="/popup-close.svg" />
            </button>
        </div>
        <hr />
        <div class="modal-body">
            <div class="input-container">
                <select id="roomNo" name="roomNo" class="custom-input" [(ngModel)]="roomNo" required
                    #surgeryTimeModel="ngModel">
                    <option value="" disabled selected>Select Room</option>
                    <option value="OT 1">OT 1</option>
                    <option value="OT 2">OT 2</option>
                    <option value="OT 3">OT 3</option>
                    <option value="OT 4">OT 4</option>
                    <option value="OT 5">OT 5</option>
                    <option value="Minor 1">Minor 1</option>
                    <option value="Minor 2">Minor 2</option>
                </select>
                <label for="surgeryTime" class="custom-label">OT Room*</label>
            </div>

            <div *ngIf="doctorsForMultipleSurgery.length > 0">
                <label class="estimation-type-label">Select Primary Surgeon:</label>

                <div *ngFor="let doctor of doctorsForMultipleSurgery" class="radio-option">
                    <input type="radio" name="primarySurgeon" [value]="doctor.id" (change)="setPrimarySurgeon(doctor)"
                        [(ngModel)]="primarySurgeonId" />
                    <label>{{ doctor.name }}</label>
                </div>
            </div>

            <div class="estimation-type-container">
                <label class="estimation-amount-label">Amount Paid:</label>
                <div class="radio-buttons">
                    <label>
                        <input type="radio" name="amountPaid" [(ngModel)]="amountPaid" [value]='true' />
                        Yes
                    </label>
                    <label>
                        <input type="radio" name="amountPaid" [(ngModel)]="amountPaid" [value]='false' />
                        No
                    </label>
                </div>
            </div>


        </div>
        <div class="modal-footer">
            <button mat-raised-button (click)="!isButtonClicked && updateEstimation()" class="save-button"
                [disabled]="isButtonClicked" [class.spinner]="isButtonLoading"> <span>Update</span></button>
            <button class="close-button" (click)="closePopup()">Close</button>
        </div>
    </div>
</div>