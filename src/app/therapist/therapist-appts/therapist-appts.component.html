<div class="form-row">
  <!-- Dropdown for Search By -->
  <div class="column-1">
    <div class="p-field p-col-2">
      <p-dropdown [options]="searchOptions" [(ngModel)]="selectedSearchOption" placeholder="Search By"
        (ngModelChange)="onSearch()" class="custom-dropdown"></p-dropdown>
    </div>

    <div class="p-field p-col-3">
      <input pInputText [(ngModel)]="searchValue" placeholder="Search / 123456" class="custom-input-text"
        (ngModelChange)="onSearch()" />
    </div>

    <!-- Search and Clear Buttons -->
    <div class="p-field p-col-2 buttons-container">
      <!-- <img (click)="onSearch()" src="/icons/search.png"> -->
      <svg (click)="onClear()" class="delete" xmlns="http://www.w3.org/2000/svg" width="3.5em" height="3.5em"
        viewBox="0 0 24 24">
        <path fill="#fff"
          d="M7 21q-.825 0-1.412-.587T5 19V6q-.425 0-.712-.288T4 5t.288-.712T5 4h4q0-.425.288-.712T10 3h4q.425 0 .713.288T15 4h4q.425 0 .713.288T20 5t-.288.713T19 6v13q0 .825-.587 1.413T17 21zM17 6H7v13h10zm-7 11q.425 0 .713-.288T11 16V9q0-.425-.288-.712T10 8t-.712.288T9 9v7q0 .425.288.713T10 17m4 0q.425 0 .713-.288T15 16V9q0-.425-.288-.712T14 8t-.712.288T13 9v7q0 .425.288.713T14 17M7 6v13z" />
      </svg>
      <!-- <img (click)="onClear()" class="delete" src="/icons/delete-1.png" pTooltip="Delete"> -->
    </div>
  </div>


  <div class="p-field p-col-3 calendar" style="display: flex;gap:20px">
    <!-- <p-calendar [(ngModel)]="selectedDate" placeholder="Calendar" class="custom-calendar"></p-calendar> -->
    <!-- <div>
        <p-calendar 
        styleClass="custom-calendar" 
        [(ngModel)]="selectedDateRange"
        selectionMode="range"
        (ngModelChange)="onSearch()"
        
        placeholder="Calendar"
        dateFormat="dd-mm-yy">
          <ng-template pTemplate="date" let-date>
              <span>
                  {{ date.day }}
              </span>
          </ng-template>
      </p-calendar>
      <i class="fa-solid fa-angle-down calendar-icon"></i>
      <svg pTooltip="Refresh" (click)="refresh()" class="reverse" xmlns="http://www.w3.org/2000/svg" width="2.5em" height="2.5em" viewBox="-1.5 -2.5 24 24"><path fill="currentColor" d="m4.859 5.308l1.594-.488a1 1 0 0 1 .585 1.913l-3.825 1.17a1 1 0 0 1-1.249-.665L.794 3.413a1 1 0 1 1 1.913-.585l.44 1.441C5.555.56 10.332-1.035 14.573.703a9.38 9.38 0 0 1 5.38 5.831a1 1 0 1 1-1.905.608A7.381 7.381 0 0 0 4.86 5.308zm12.327 8.195l-1.775.443a1 1 0 1 1-.484-1.94l3.643-.909a1 1 0 0 1 .61-.08a1 1 0 0 1 .84.75l.968 3.88a1 1 0 0 1-1.94.484l-.33-1.322a9.381 9.381 0 0 1-16.384-1.796l-.26-.634a1 1 0 1 1 1.851-.758l.26.633a7.381 7.381 0 0 0 13.001 1.25z"/></svg>

      </div> -->
  </div>
</div>


<div class="table-container" [ngClass]="{'loading': isLoading}" *ngIf="!isLoading">
  <div class="table-wrapper">
    <table class="appointment-table">
      <thead>
        <tr>
          <th>No</th>
          <th (click)="sortBy('name')" style="cursor: pointer;">
            Patient Name
            <span *ngIf="sortColumn === 'name' && sortDirection === 'asc'">&#9650;</span>
            <span *ngIf="sortColumn === 'name' && sortDirection === 'desc'">&#9660;</span>
          </th>
          <th>PRN</th>
          <th>Therapy Name</th>
          <th style="cursor: pointer;">
            Time
          </th>
          <th>Room No</th>
          <!-- <th>Source</th> -->
          <!-- <th>SMS</th>
                    <th>Email</th>
                    <th>WA</th> -->
          <!-- <th>Status</th> -->
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="filteredServices.length === 0">
          <td colspan="11" class="no-records-message">
            No records to display
          </td>
        </tr>
        <tr *ngFor="let service of getPaginatedAppointments(); let i = index">
          <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
          <td>{{ service.name }}</td>
          <td>{{ service.prn || '-'}}</td>
          <td>{{ service.therapyNames }}</td>
          <td>{{ service.time }}</td>
          <td>{{ service.roomNumber }}</td>
          <td class="button">
            <!-- <button class="start" [disabled]="service.entryDone" (click)="completeAppointment(service)">
              <img class="image" src="/start.svg">Entry
            </button> -->
            <button class="finish" [disabled]="service.therapyStarted"
              (click)="startTherapy(service)">
              <img class="image" src="/finish.svg"> Start
            </button>
            <button class="postPond" [disabled]="service.postponed"
              (click)="!service.therapyStarted && postponeTherapy(service)">
              <img class="image" src="/pause.svg">Postpone
            </button>
            <!-- NEW: Therapy End -->
            <button class="endTherapy" [disabled]="service.therapyEnded"
              (click)="service.therapyStarted && endTherapy(service)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
                <g fill="#008080">
                  <path
                    d="M12.5 16a3.5 3.5 0 1 0 0-7a3.5 3.5 0 0 0 0 7m1.679-4.493l-1.335 2.226a.75.75 0 0 1-1.174.144l-.774-.773a.5.5 0 0 1 .708-.708l.547.548l1.17-1.951a.5.5 0 1 1 .858.514M11 5a3 3 0 1 1-6 0a3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4a2 2 0 0 0 0 4" />
                  <path
                    d="M8.256 14a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226-.341.496-.65.804-.918Q8.844 9.002 8 9c-5 0-6 3-6 4s1 1 1 1z" />
                </g>
              </svg> End
            </button>

            <!-- NEW: Cleaning Start -->
            <button class="cleanStart" [disabled]="service.cleaningEnded || !service.therapyEnded"
              (click)="service.therapyEnded && startCleaning(service)">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                <path fill="#A52B0E"
                  d="m14.99 7l1.37-.63l.63-1.37l.63 1.37l1.37.63l-1.37.63L16.99 9l-.63-1.37zM20 14c1.1 0 2-.9 2-2c0-.78-.99-2.44-1.58-3.36a.496.496 0 0 0-.84 0C18.99 9.56 18 11.22 18 12c0 1.1.9 2 2 2M9.24 9.5L15 11.65V11a5 5 0 0 0-4-4.9V4h2c.35 0 .68.06 1 .18c.37.13.78.05 1.05-.22c.51-.51.34-1.39-.33-1.64C14.19 2.11 13.61 2 13 2H8.5c-.55 0-1 .45-1 1s.45 1 1 1H9v2.11c-1.78.37-3.2 1.68-3.75 3.39zM3 11c-1.1 0-2 .9-2 2v7c0 1.1.9 2 2 2s2-.9 2-2v-7c0-1.1-.9-2-2-2m16.99 6h-6.83a1 1 0 0 1-.33-.06l-1.47-.51a.49.49 0 0 1-.3-.63c.09-.26.38-.4.64-.3l1.12.43c.11.04.24.07.36.07h2.63c.65 0 1.18-.53 1.18-1.18c0-.49-.31-.93-.77-1.11L9.3 11.13c-.22-.09-.46-.13-.7-.13H7v9.02l6.37 1.81c.41.12.85.1 1.25-.05L22 19c0-1.11-.9-2-2.01-2" />
              </svg>Clean Start
            </button>
            <button class="clean" [disabled]="service.cleanedAfterUse"
              (click)="service.therapyStarted && cleanRoom(service)">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" class="image" viewBox="0 0 48 48">
                <path fill="#BA2C7C" fill-rule="evenodd"
                  d="M21.493 20.43c1.362-4.994 2.731-10.015 3.848-15.077c.244-1.106-.021-2.46-1.315-2.941q-.333-.125-.761-.24c-.428-.116-.545-.133-.78-.173c-1.36-.23-2.266.81-2.608 1.89c-1.57 4.961-2.9 10.014-4.222 15.04l-.02.073q.11-.003.219-.002c2.143 0 4.03.529 5.639 1.43M27 28a2 2 0 0 1 2-2h10a2 2 0 1 1 0 4H29a2 2 0 0 1-2-2m5 6a2 2 0 1 0 0 4h10a2 2 0 1 0 0-4zm3 8a2 2 0 1 0 0 4h10a2 2 0 1 0 0-4zM15.854 21.5c-6.044 0-10.64 4.527-12.119 10.068c-.885 3.32-1.764 7.237-2.096 10.722c-.223 2.343 1.512 4.274 3.736 4.534c1.042.122 2.348.259 3.809.377c-1.705-3.667-1.818-7.556-1.602-9.377a1.5 1.5 0 0 1 2.979.352c-.204 1.726-.004 5.909 2.164 9.249c1.07.047 2.172.075 3.275.075c1.1 0 2.254-.028 3.412-.075c-1.139-1.627-1.822-3.393-2.234-4.905a20 20 0 0 1-.592-3.16a17 17 0 0 1-.084-1.243l-.002-.08V38a1.501 1.501 0 0 1 3-.002v.052l.008.202c.009.182.026.454.062.795c.072.684.216 1.633.502 2.683c.513 1.882 1.447 3.959 3.116 5.486c.848-.058 1.668-.12 2.437-.185c3.54-.292 4.951-4.549 2.481-6.973L27 38.973a5.5 5.5 0 0 1-1.647-4.051l.057-2.57c.121-5.481-3.587-10.852-9.556-10.852"
                  clip-rule="evenodd" />
              </svg>Clean End
            </button>
            <button class="over" [disabled]="service.therapyFinished"
              (click)="service.cleanedAfterUse && finishTherapy(service)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
                <path fill="#6F46C1"
                  d="M9 5a3 3 0 1 1-6 0a3 3 0 0 1 6 0m-9 8c0 1 1 1 1 1h10s1 0 1-1s-1-4-6-4s-6 3-6 4m13.5-8.09c1.387-1.425 4.855 1.07 0 4.277c-4.854-3.207-1.387-5.702 0-4.276Z" />
              </svg>Finish
            </button>
            <button class="cancel" [disabled]="service.entryDone"
              (click)="!service.entryDone && cancelAppointment(service)">
              <img class="image" src="/radio-cancel.svg" alt="cancel">Cancel
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <div class="pagination">
    <button class="pagination-btn prev" (click)="prevPage()" [disabled]="currentPage === 1">←</button>
    <button class="pagination-btn next" (click)="nextPage()" [disabled]="currentPage === totalPages">→</button>
    <div class="page-info">
      Page
      <input type="number" [(ngModel)]="currentPage" min="1" [max]="totalPages" class="page-input"
        (change)="onPageChange()">
      of {{ totalPages }}
    </div>
  </div>
  <p-toast></p-toast>

</div>
<div class="loader" *ngIf="isLoading"></div>